{% extends "base.html" %}

{% block title %}
  <title>FitBug: Fitness Data Chart Output</title>
{% endblock %}


{% block styles %}
  <!-- 🧾 External CSS specific to the results page -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style_output.css') }}">
{% endblock %}

{% block content %}
<div class="container">
  <h2>Fitness Data Charts</h2>


  {# Flash messages (e.g., success or error) #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
  {% endwith %}

  {# 📝 Display current visibility level #}
  <p><strong>Current Sharing Option:</strong> {{ visibility|capitalize }}</p>

  {# 📊 Chart type selection dropdown #}
  <label for="chartType">Select Chart Type:</label><br>
  <select id="chartType" onchange="renderAllCharts()">
    <option value="line">Line Chart</option>
    <option value="bar">Bar Chart</option>
    <option value="pie">Pie Chart</option>
    <option value="doughnut">Doughnut Chart</option>
    <option value="radar">Radar Chart</option>
    <option value="scatter">Scatter Plot</option>
  </select><br><br>


  {# 🔁 Loop through each selected column and render its chart + stats #}
  {% for column in columns %}
    <div class="chart-block">
      <h4>{{ column }}</h4>
      <canvas id="chart-{{ loop.index0 }}" class="chart-canvas" width="600" height="300"></canvas>

      <ul style="list-style: none; padding-left: 0;">
        <li><strong>Average:</strong> {{ (values[column] | sum / values[column] | length) | round(2) }}</li>
        <li><strong>Maximum:</strong> {{ values[column] | max }}</li>
        <li><strong>Minimum:</strong> {{ values[column] | min }}</li>
      </ul>

      <button class="btn" onclick="downloadChart({{ loop.index0 }}, '{{ column }}')">Download {{ column }} Chart</button>
    </div>
    <hr>
  {% endfor %}

  {# 📥 Download all charts at once #}
  <button class="btn" onclick="downloadAllCharts()">Download All Charts</button>

  {# 🔁 Go back to column selection step #}
  <a href="{{ url_for('select_columns') }}" class="btn btn-secondary" style="margin-top: 10px;">🔙 Reselect Columns</a>

  {# 🌍 Sharing visibility form (POST to /set_visibility) #}

  <form method="POST" action="{{ url_for('set_visibility') }}" style="margin-top: 20px;">
    <label for="visibility">Change Sharing Option:</label>
    <select name="visibility">
      <option value="private" {% if visibility == 'private' %}selected{% endif %}>Private</option>
      <option value="public" {% if visibility == 'public' %}selected{% endif %}>Public</option>
      <option value="friends" {% if visibility == 'friends' %}selected{% endif %}>Friends</option>
    </select>
    <button type="submit" class="btn">Save Sharing Setting</button>
  </form>
</div>
{%endblock%}


{% block scripts %}
  <!-- Chart.js CDN -->
  {# Chart.js setup and dynamic rendering logic #}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const chartTypeSelector = document.getElementById('chartType');
    const labels = {{ labels | tojson }};
    const values = {{ values | tojson }};
    const columns = {{ columns | tojson }};
    let charts = [];

    function renderAllCharts() {
      charts.forEach(c => c.destroy());
      charts = [];

      const selectedType = chartTypeSelector.value;

      columns.forEach((colName, i) => {
        const ctx = document.getElementById(`chart-${i}`).getContext('2d');
        const config = {
          type: selectedType,
          data: {
            labels: labels,
            datasets: [{
              label: colName,
              data: values[colName],
              backgroundColor: 'rgba(75, 192, 192, 0.4)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 2,
              fill: selectedType === 'line' || selectedType === 'radar',
              showLine: selectedType !== 'scatter',
              pointRadius: selectedType === 'scatter' ? 5 : 3,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true }
            },
            scales: (['pie', 'doughnut'].includes(selectedType)) ? {} : {
              y: { beginAtZero: true },
              x: {
                ticks: {
                  autoSkip: true,
                  maxRotation: 45,
                  minRotation: 0
                }
              }
            }
          }
        };

        const chart = new Chart(ctx, config);
        charts.push(chart);
      });
    }

    function downloadChart(index, name) {
      const canvas = document.getElementById(`chart-${index}`);
      const ctx = canvas.getContext("2d");
      const originalImage = ctx.getImageData(0, 0, canvas.width, canvas.height)
      ctx.save();
      ctx.globalCompositeOperation = "destination-over";
      ctx.fillStyle = "#ffffff"
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.restore();

      const image = canvas.toDataURL("image/png")
      const link = document.createElement('a');
      link.href = image;
      link.download = `${name}_chart.png`;
      link.click();

      ctx.putImageData(originalImage, 0, 0);
    }

    function downloadAllCharts() {
      columns.forEach((col, i) => downloadChart(i, col));
    }

    document.addEventListener("DOMContentLoaded", renderAllCharts);
  </script>
{% endblock %}