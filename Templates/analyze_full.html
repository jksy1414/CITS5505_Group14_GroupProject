{% extends "base.html" %}

{% block title %}
  <title>FitBug: Full Data Analysis</title>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_analyze.css') }}">
<style>
  .tab-section { display: none; }
  .tab-section.active { display: block; }
  .step-buttons { margin-top: 20px; }
  .step-buttons button { margin-right: 10px; }
  .step-indicator {
    display: flex;
    justify-content: space-between;
    margin: 20px 0;
  }
  .step-indicator div {
    flex: 1;
    text-align: center;
    padding: 10px;
    border-bottom: 4px solid #ccc;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .step-indicator .active {
    font-weight: bold;
    border-color: #5a3e1b;
    background-color: #f5f5dc;
  }
  .step-indicator .disabled {
    opacity: 0.4;
    pointer-events: none;
    cursor: not-allowed;
  }
</style>
{% endblock %}

{% block content %}
<h2 class="main-heading">Fitness Data Analyzer</h2>

<div class="step-indicator">
  <div id="step-label-0" class="{{ 'active' if step == 'upload' else '' }}" onclick="switchStep(0)">
    1. Upload Data
  </div>
  <div id="step-label-1" class="{{ 'active' if step == 'columns' else '' }}" onclick="handleStepClick(1)">
    2. Select Columns
  </div>
  <div id="step-label-2" class="{{ 'active' if step == 'rename' else '' }}" onclick="handleStepClick(2)">
    3. Rename Headers
  </div>
  <div id="step-label-3" class="{{ 'active' if step == 'results' else '' }}" onclick="handleStepClick(3)">
    4. View Results
  </div>
</div>

<!-- Step 1: Upload CSV -->
<div class="tab-section {% if step == 'upload' %}active{% endif %}" id="step-0">
  <form method="POST" enctype="multipart/form-data" action="{{ url_for('auth.analyze_full') }}">
    <input type="hidden" name="step" value="upload">
    <label for="fileUpload">Choose CSV file (UTF-8 only):</label><br>
    <input type="file" id="fileUpload" name="fitnessFile" accept=".csv" required><br>
    <div class="alert alert-warning">
      ⚠️ Only <strong>CSV files saved as UTF-8 encoding</strong> are accepted.
    </div>
    <div class="step-buttons">
      <button type="submit" class="btn">Next →</button>
    </div>
  </form>
</div>

<!-- Step 2: Select Columns -->
<div class="tab-section {% if step == 'columns' %}active{% endif %}" id="step-1">
  <form method="POST" action="{{ url_for('auth.analyze_full') }}">
    <input type="hidden" name="step" value="columns">
    <label>Select the data column(s) to analyze:</label><br>
    <div class="checkbox-group">
      {% for column in columns %}
        <label><input type="checkbox" name="columns" value="{{ column }}"> {{ column }}</label>
      {% endfor %}
    </div>
    <div class="step-buttons">
      <button type="button" onclick="switchStep(0)" class="btn btn-secondary">← Back</button>
      <button type="submit" class="btn">Next →</button>
    </div>
  </form>
</div>

<!-- Step 3: Rename Headers -->
<div class="tab-section {% if step == 'rename' %}active{% endif %}" id="step-2">
  <form method="POST" action="{{ url_for('auth.analyze_full') }}">
    <input type="hidden" name="step" value="rename">
    <label>Rename headers for selected columns:</label>
    <table>
      <thead>
        <tr><th>Detected Header</th><th>Choose Existing or New</th><th>Custom Name</th></tr>
      </thead>
      <tbody>
        {% for col in selected_columns %}
        <tr>
          <td>{{ col }}</td>
          <td>
            <select name="header_map_{{ loop.index0 }}" onchange="handleRenameOption(this, {{ loop.index0 }})">
              {% for opt in predefined_headers %}
                <option value="{{ opt }}">{{ opt }}</option>
              {% endfor %}
              <option value="custom">Create New</option>
            </select>
          </td>
          <td>
            <input type="text" name="custom_{{ loop.index0 }}" id="custom_{{ loop.index0 }}" style="display:none;" placeholder="e.g., Steps_Week1">
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="step-buttons">
      <button type="button" onclick="switchStep(1)" class="btn btn-secondary">← Back</button>
      <button type="submit" class="btn">Next →</button>
    </div>
  </form>
</div>

<!-- Step 4: Results -->
<div class="tab-section {% if step == 'results' %}active{% endif %}" id="step-3">
  <div style="display: flex; gap: 20px;">
    <div style="width: 220px; overflow-y: auto; max-height: 500px;">
      <h4>Select Column</h4>
      <ul style="list-style-type: none; padding: 0;" id="columnList">
        {% for orig, new in renamed_headers.items() %}
        <li><button class="btn btn-secondary" onclick="selectColumn('{{ new }}')">{{ new }}</button></li>
        {% endfor %}
      </ul>
    </div>

    <div style="flex: 1;">
      <div style="display: flex; gap: 20px; align-items: center;">
        <label>Chart Type:</label>
        <select id="chartType" onchange="renderChart()">
          <option value="line">Line</option>
          <option value="bar">Bar</option>
          <option value="pie">Pie</option>
          <option value="doughnut">Doughnut</option>
          <option value="radar">Radar</option>
          <option value="scatter">Scatter</option>
        </select>

        <label>Background:</label>
        <input type="color" id="bgColor" value="#ffffff" onchange="renderChart()">
      </div>

      <h4 id="selectedColumnLabel"></h4>
      <canvas id="dynamicChart" width="700" height="300"></canvas>
      <ul id="statSummary"></ul>
      <button onclick="downloadChart()" class="btn">Download</button>

      <div class="step-buttons">
        <button type="button" onclick="switchStep(2)" class="btn btn-secondary">← Back</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const stepMap = {
    'upload': 0,
    'columns': 1,
    'rename': 2,
    'results': 3
  };
  const labels = {{ labels | tojson }};
  const values = {{ values | tojson }};
  const renamedHeaders = {{ renamed_headers | tojson }};
  const step = '{{ step }}';
  const csvUploaded = {{ 'true' if csv_uploaded else 'false' }};

  let currentStep = stepMap[step] || 0;
  let dynamicChart = null;

  function switchStep(index) {
    document.querySelectorAll('.tab-section').forEach((tab, i) => {
      tab.classList.toggle('active', i === index);
      document.getElementById(`step-label-${i}`).classList.toggle('active', i === index);
    });
    currentStep = index;
  }

  function handleStepClick(index) {
    if (!csvUploaded && index > 0) {
      alert('Please upload a CSV file first.');
      return;
    }
    switchStep(index);
  }

  function handleRenameOption(el, idx) {
    document.getElementById(`custom_${idx}`).style.display = el.value === 'custom' ? 'inline' : 'none';
  }

  function selectColumn(col) {
    renderChart(col);
  }

  function renderChart(selectedCol = null) {
    const type = document.getElementById('chartType').value;
    const bgColor = document.getElementById('bgColor').value;
    const label = selectedCol || document.getElementById('selectedColumnLabel').innerText;

    if (!label || !Object.values(renamedHeaders).includes(label)) return;

    const originalCol = Object.keys(renamedHeaders).find(k => renamedHeaders[k] === label);
    const data = values[originalCol] || [];

    const ctx = document.getElementById('dynamicChart').getContext('2d');
    if (dynamicChart) dynamicChart.destroy();

    document.getElementById('selectedColumnLabel').innerText = label;

    dynamicChart = new Chart(ctx, {
      type: type,
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          backgroundColor: 'rgba(75,192,192,0.4)',
          borderColor: 'rgba(75,192,192,1)',
          borderWidth: 2,
          fill: ['line', 'radar'].includes(type),
          showLine: type !== 'scatter'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: ['pie', 'doughnut'].includes(type) ? {} : {
          y: { beginAtZero: true },
          x: { ticks: { autoSkip: true } }
        }
      }
    });

    ctx.canvas.parentElement.style.backgroundColor = bgColor;

    const stats = document.getElementById('statSummary');
    stats.innerHTML = '';
    if (data.length > 0) {
      stats.innerHTML += `<li><strong>Average:</strong> ${average(data)}</li>`;
      stats.innerHTML += `<li><strong>Max:</strong> ${Math.max(...data)}</li>`;
      stats.innerHTML += `<li><strong>Min:</strong> ${Math.min(...data)}</li>`;
    }
  }

  function average(arr) {
    const sum = arr.reduce((a, b) => a + b, 0);
    return (sum / arr.length).toFixed(2);
  }

  function downloadChart() {
    const canvas = document.getElementById('dynamicChart');
    const link = document.createElement('a');
    link.href = canvas.toDataURL();
    link.download = 'chart.png';
    link.click();
  }

  document.addEventListener("DOMContentLoaded", () => {
    switchStep(currentStep);

    // Optional enhancement: Disable tabs 1-3 if CSV not uploaded
    if (!csvUploaded) {
      [1, 2, 3].forEach(i => {
        document.getElementById(`step-label-${i}`).classList.add('disabled');
      });
    }
  });
</script>
{% endblock %}
